#!/usr/bin/env bash

set -eu -o pipefail

## Ask a yes/no question
ask() {
	while true; do
		echo -n "$@ [Y,n] "
		read yn
		case "$yn" in
			[Yy]* ) return 0;;
			""    ) return 0;;
			[Nn]* ) return 1;;
			* ) echo "Please answer yes or no.";;
		esac
	done
}

## list of subcommands
subcommands=("help" "init" "upgrade" "ports" "start" "stop" "up" "build" "run" "bash" "local" "h" "p" "s" "u" "b" "r")

## state directory for persistent data
STATE_DIR="$HOME/.local/state/dev"
mkdir -p "$STATE_DIR"

project=""
command="bash"

# function to check if string is a subcommand
is_subcommand() {
	[[ " ${subcommands[@]} " =~ " $1 " ]]
}

## check if any arguments are given
if [[ $# -eq 0 ]]; then
	true;
	# use default settings
else
	# check if project is given
	if is_subcommand "$1"
	then
		true;
	else
		project="$1"
		shift
	fi
fi

# check if project is set
if [[ -z "$project" ]]; then
	# no project given, try to restore last project
	if [[ -f "$STATE_DIR/last.project" ]]; then
		project=$(cat "$STATE_DIR/last.project")
	fi
fi

# validate project name
if [[ -z "$project" ]]; then
	echo "Couldn't detect project, please provide a project name"
	exit 1
elif [[ ! "$project" =~ ^[a-zA-Z0-9_-]+$ ]]; then
	echo "Invalid project name '$project'. Only letters, numbers, underscores, and hyphens allowed."
	exit 7
fi

# check command
if [[ $# -eq 0 ]]; then
	true;
else
	if is_subcommand "$1"
	then
		command=$1
		shift
	else
		echo "Invalid command: $1"
		exit 2
	fi
fi

# check if project exists in ~/projects
if [[ ! -d "${HOME}/projects/${project}" ]]; then
	echo "Project ${project} not found in ~/projects"
	[[ "$command" == "init" ]] || exit 5
	ask "Create ${HOME}/projects/${project}/ ?" || exit 5
	mkdir "${HOME}/projects/${project}/"
fi

# check if project has a container directory
if [[ ! -d "${HOME}/projects/${project}/dev" ]]; then
	echo "Project ${project} has no ./dev/ directory"
	[[ "$command" == "init" ]] || exit 6

	# initialize the project
	cd "${HOME}/projects/${project}"
	echo "Init project ${project} in $(pwd)"
	ask "Clone the github.com/f0i/dev repository into ${HOME}/projects/${project}/dev" || exit 0

	git clone https://github.com/f0i/dev
	cd dev
	git submodule init
	git submodule update

	# copy user configuration
	if ask "Copy your SSH public key and .gitconfig?"; then
		# copy SSH key
		if [ -f ~/.ssh/id_ed25519.pub ]; then
			cp ~/.ssh/id_ed25519.pub setup/user/key.pub
			echo "Copied SSH key from ~/.ssh/id_ed25519.pub"
		elif [ -f ~/.ssh/id_rsa.pub ]; then
			cp ~/.ssh/id_rsa.pub setup/user/key.pub
			echo "Copied SSH key from ~/.ssh/id_rsa.pub"
		else
			echo "Warning: No SSH key found at ~/.ssh/id_ed25519.pub or ~/.ssh/id_rsa.pub"
		fi

		# copy gitconfig
		if [ -f ~/.gitconfig ]; then
			cp ~/.gitconfig setup/user/gitconfig
			echo "Copied .gitconfig"
		else
			echo "Warning: No git config found at ~/.gitconfig"
		fi
	else
		echo "Skipped copying personal configuration."
		echo "To enable port forwarding, add your SSH public key to: setup/user/key.pub"
		echo "To configure git, edit: setup/user/gitconfig"
		echo "Note: Without an SSH key, the 'dev ports' command will not work."
	fi

	nvim Dockerfile
	exit 0

fi

# save project name
echo "${project}" > "$STATE_DIR/last.project"

# change to project directory
cd "${HOME}/projects/${project}/dev"

container="$project-dev-1"

# function to show usage information
help ()
{
	echo "Connect to a development environment inside docker."
	echo ""
	echo "$0 [<project>] [<command> [args...]]"
	echo ""
	echo "<project>: name of a project, located in ~/projects/<project>."
	echo "           Must contain a subdirectory called ./dev (see https://github.com/f0i/dev)"
	echo "           If no project is given, the last used project will be used."
	echo ""
	echo "<command>: one of the following commands:"
	echo "  help (h): show this help"
	echo "  ports (p): set port mappings"
	echo "  start (s) stop up (u) build (b): docker-compose commands"
	echo "  run: run a command inside the container"
	echo "  bash (default): start a bash shell inside the container"
	echo "  local: start a bash shell on the host inside the project directory"
	echo "  init: add ./dev/ to an existing project"
	echo "  upgrade: pull the latest changes from github.com/f0i/dev repository"
}

# execute command
case "$command" in
	"h"|"help")
		help
		;;
	"p"|"ports")
		./bin/ports "$project" "$@"
		;;
	"s"|"start")
		docker-compose -p "$project" up -d
		;;
	"stop")
		docker-compose -p "$project" stop
		;;
	"up"|"u")
		docker-compose -p "$project" up
		;;
	"build"|"b")
		docker-compose -p "$project" build
		;;
	"run"|"r")
		docker exec -itu node -w /workspace "$container" "$@"
		;;
	"bash")
		docker exec -itu node -w /workspace "$container" bash
		;;
	"local")
		cd ..
		bash
		;;
	"init")
		# already handeld above if needed
		exit 3
		;;
	"upgrade")
		# git pull and update submodules
		git pull
		git submodule update --init --recursive
		;;
	*)
		echo "Invalid command: $command"; 
		exit 4
		;;
esac

